<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font: 13px Helvetica, Arial;
        }

        form {
            background: #000;
            padding: 3px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        form input {
            border: 0;
            padding: 10px;
            width: 90%;
            margin-right: .5%;
        }

        form button {
            width: 9%;
            background: rgb(130, 224, 255);
            border: none;
            padding: 10px;
        }

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        #messages li {
            padding: 5px 10px;
        }

        #messages li:nth-child(odd) {
            background: #eee;
        }

        #start-stream, #stop-stream, #pay-stream {
            cursor: pointer;
            width: 200px;
            height: 100px;
            background: #cccccc;
            display: inline-block;
            padding-top: 40px;
            text-align: center
        }

        #start-stream.hidden, #stop-stream.hidden, #pay-stream.hidden {
            display: none;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<a id="start-stream">Start stream</a><a id="stop-stream">Stop stream</a>
<a id="pay-stream">Pay stream</a>

<div class="video-wrapper">
    <video id="video" autoplay></video>
</div>
<div class="img-wrapper">
    <img src="" alt="">
</div>
<ul id="messages"></ul>
<form id="form" action="">
    <input id="m" autocomplete="off"/>
    <button>Отправить</button>
</form>
<template id="liMessage">
    <li></li>
</template>
<script src="http://localhost:3000/node_modules/socket.io-client/dist/socket.io.js"></script>
<script>
    let video = document.querySelector('#video');
    let img = document.querySelector('img');
    let mainUser = 0;
    let startStreamButton = document.getElementById('start-stream');
    let stopStreamButton = document.getElementById('stop-stream');
    let socket = io('http://localhost:3000');
    let intervalID ;
    checkState();
    socket.on('connect', connectUser);
    startStreamButton.addEventListener('click', startStream);
    stopStreamButton.addEventListener('click', stopStream);
    window.addEventListener('beforeunload', stopStream);

    function connectUser() {
        console.log('connect');
        socket.on('start stream', startStreamSocket);
        socket.on('check state', checkStateSocket);
        socket.on('stop stream', stopStreamSocket);
    }

    function startStream() {
        navigator.mediaDevices.getUserMedia({
            video: {
                width: 426,
                height: 240
            }
        }).then((stream) => video.srcObject = stream);
        mainUser = 1;
        startStreamButton.classList.add('hidden');
        sendStream();
    }

    function closeWindow() {
        socket.emit('close window', mainUser)
    }

    function stopStream() {
        clearSendStream();
        stopStreamedVideo(video);

        startStreamButton.classList.remove('hidden');
        socket.emit('stop stream');
    }

    function checkState() {
        socket.emit('check state')
    }

    function checkStateSocket(state) {
        if (state === 'disabled') {
            startStreamButton.classList.add('hidden');
            stopStreamButton.classList.add('hidden')
        } else {
            startStreamButton.classList.remove('hidden');
            startStreamButton.classList.remove('hidden');
        }
    }

    function startStreamSocket(video) {
        img.classList.remove('hidden')
        img.src = video;
        stopStreamButton.classList.add('hidden');
        startStreamButton.classList.add('hidden');
    }

    function stopStreamSocket() {
        img.classList.add('hidden')
        stopStreamButton.classList.remove('hidden');
        startStreamButton.classList.remove('hidden')
    }


    function sendStream() {
        intervalID = setInterval(() => {
            socket.emit('start stream', getFrame());
        }, 50);
    }


    function clearSendStream() {
        clearInterval(intervalID);
    }

    // checkDisconnected();
    // function checkDisconnected() {
    //     socket.on('close', mainUser);
    // }

    let form = document.querySelector('form');
    let btnSubmit = document.querySelector('button');
    let messages = document.getElementById('messages');
    let m = document.getElementById('m');

    //
    // let mainUser = false;
    // let stopStreamButton = document.getElementById('stop-stream');
    btnSubmit.addEventListener('click', submitForm);
    form.addEventListener('submit', submitForm);

    // stream.addEventListener('click', startStream);
    function submitForm(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log(m.value);
        socket.emit('chat message', m.value);
        m.value = '';
        return false
    }

    socket.addEventListener('chat message', addMessage);

    function addMessage(msg) {
        let liTemplate = document.getElementById('liMessage');
        let li = liTemplate.content.querySelector('li');
        li.textContent = msg;
        let clone = document.importNode(liTemplate.content, true);
        messages.appendChild(clone)
    }

    //
    // const video = document.querySelector('#video');
    // stream.addEventListener('click', openStream);
    // function openStream(e) {
    //     socket.addEventListener('stream', startStream);
    //     navigator.mediaDevices.getUserMedia({video: {width: 426, height: 240}}).then((stream) => video.srcObject = stream);
    //     setInterval(() => {
    //         socket.emit('stream', getFrame());
    //     },  50);
    // }
    //
    // socket.addEventListener('stream', startStream);
    // stopStreamButton.addEventListener('click', stopStream);
    // function stopStream() {
    //     socket.emit('stop stream');
    //     socket.addEventListener('stop stream', startStream);
    // }
    //

    //
    //
    // function startStream(stream3) {
    //     if (stream3 === 'stop') {
    //         alert('stop stream');
    //         socket.removeEventListener('stream', startStream);
    //         img.hidden = true;
    //         stopStreamedVideo(video)
    //     }else {
    //         stream.hidden = true;
    //         socket.removeEventListener('stop stream', startStream);
    //         img.hidden = false;
    //         img.src = stream3;
    //     }
    // }
    let getFrame = () => {
        let canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        let dataVideo = canvas.toDataURL('video/mp4');
        return dataVideo;
    };

    function stopStreamedVideo(videoElem) {
        let video = videoElem.srcObject;
        let tracks = video.getTracks();

        tracks.forEach(function (track) {
            track.stop();
        });

        videoElem.srcObject = null;
    }

</script>
</body>
</html>